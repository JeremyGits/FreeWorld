<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Early Hardware Detection - FreeWorld OS Documentation</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <h2>Navigation</h2>
            <ul class="nav-menu">
                <li><a href="../index.html">Home</a></li>
                <li class="nav-section">Boot Components</li>
                <li><a href="bootmgr.html">BOOTMGR</a></li>
                <li><a href="bcd.html">BCD</a></li>
                <li><a href="freeload.html">freeload.exe</a></li>
                <li><a href="uefi-boot.html">UEFI Boot</a></li>
                <li class="nav-section">Core System</li>
                <li><a href="kernel.html">fwoskrnl.exe</a></li>
                <li><a href="early-hardware-detection.html">Early Hardware Detection</a></li>
                <li><a href="acpi-support.html">ACPI Support</a></li>
                <li><a href="boot-parameters.html">Boot Parameters</a></li>
                <li><a href="hal.html">hal.dll</a></li>
                <li><a href="io-infrastructure.html">I/O Infrastructure</a></li>
                <li><a href="memory.html">Memory Management</a></li>
                <li><a href="drivers.html">Device Drivers</a></li>
                <li><a href="process.html">Process Management</a></li>
                <li><a href="execve.html">execve() System Call</a></li>
                <li><a href="resource-manager.html">Resource Manager</a></li>
                <li><a href="ipc-system.html">IPC System</a></li>
                <li><a href="filesystem-kernel.html">File System</a></li>
                <li><a href="kernel-decompression.html">Kernel Decompression</a></li>
                <li><a href="elf-loader.html">ELF Loader</a></li>
                <li><a href="graphics.html">Graphics System</a></li>
                <li><a href="minimal-libc.html">Minimal C Library</a></li>
                <li><a href="build-system.html">Build System</a></li>
                <li class="nav-section">Services</li>
                <li><a href="smss.html">smss.exe</a></li>
                <li><a href="csrss.html">csrss.exe</a></li>
                <li><a href="freeworldlogon.html">freeworldlogon.exe</a></li>
                <li><a href="networkd.html">networkd</a></li>
                <li><a href="logd.html">logd</a></li>
                <li><a href="securityd.html">securityd</a></li>
                <li><a href="services-manager.html">Services Manager</a></li>
                <li><a href="task-manager.html">Task Manager</a></li>
                <li class="nav-section">User Interface</li>
                <li><a href="shell.html">Shell</a></li>
                <li><a href="wanderer.html">Wanderer</a></li>
                <li><a href="fwmic.html">FWMIC</a></li>
            </ul>
        </nav>

        <main class="content">
            <div class="page-header">
                <h1>Early Hardware Detection</h1>
                <div class="meta">
                    <strong>Location:</strong> <code>kernel/hardware/early_detection.asm</code><br>
                    <strong>Type:</strong> Kernel Component<br>
                    <strong>Status:</strong> ✅ Fully Implemented
                </div>
            </div>

            <section class="section">
                <h2>Overview</h2>
                <p>The FreeWorld OS early hardware detection system comprehensively detects all hardware components before drivers load. This provides the kernel with complete hardware information for proper initialization, driver matching, and resource allocation.</p>
                
                <div class="status-badge status-complete">✅ Fully Implemented</div>
                <p><strong>Key Features:</strong> CPU detection, memory detection (E820/EFI), ACPI detection, full PCI enumeration, APIC detection, storage/display/network/audio/input/USB detection</p>
            </section>

            <section class="section">
                <h2>Detection Components</h2>
                
                <h3>1. CPU Detection</h3>
                <ul>
                    <li><strong>Vendor String:</strong> Intel, AMD, or other vendor</li>
                    <li><strong>Brand String:</strong> Full processor name</li>
                    <li><strong>Feature Flags:</strong> CPUID leaf 1 (MMX, SSE, AVX, etc.)</li>
                    <li><strong>Extended Features:</strong> CPUID leaf 7 (additional features)</li>
                    <li><strong>Cache Information:</strong> L1, L2, L3 cache sizes</li>
                    <li><strong>CPU Count:</strong> Number of logical processors</li>
                    <li><strong>Per-Core Info:</strong> Structure for per-core information</li>
                </ul>

                <h3>2. Memory Detection</h3>
                <ul>
                    <li><strong>E820 Support:</strong> BIOS memory map (INT 0x15, EAX=0xE820)</li>
                    <li><strong>EFI Support:</strong> UEFI memory map (from boot parameters)</li>
                    <li><strong>Memory Types:</strong> Available, reserved, ACPI reclaimable, etc.</li>
                    <li><strong>Memory Totals:</strong> Total, available, and reserved memory</li>
                    <li><strong>Memory Map:</strong> Array of memory map entries</li>
                </ul>

                <h3>3. ACPI Detection</h3>
                <ul>
                    <li><strong>RSDP Search:</strong> Memory search (EBDA, BIOS ROM)</li>
                    <li><strong>UEFI Integration:</strong> RSDP from UEFI boot parameters</li>
                    <li><strong>Version Detection:</strong> ACPI 1.0 or 2.0</li>
                    <li><strong>Checksum Validation:</strong> RSDP checksum verification</li>
                    <li><strong>Table Location:</strong> RSDP address stored</li>
                </ul>

                <h3>4. PCI Enumeration</h3>
                <ul>
                    <li><strong>Full Scan:</strong> All buses (0-255), devices (0-31), functions (0-7)</li>
                    <li><strong>Vendor/Device ID:</strong> Device identification</li>
                    <li><strong>Class Codes:</strong> Device classification</li>
                    <li><strong>Subclass:</strong> Device subclass</li>
                    <li><strong>Programming Interface:</strong> Device-specific interface</li>
                    <li><strong>Header Type:</strong> PCI header type</li>
                    <li><strong>Base Address Registers:</strong> BAR0, BAR1 for I/O and memory</li>
                    <li><strong>Device Count:</strong> Total PCI devices found</li>
                </ul>

                <h3>5. APIC Detection</h3>
                <ul>
                    <li><strong>Local APIC:</strong> CPUID feature flags check</li>
                    <li><strong>APIC Base:</strong> MSR IA32_APIC_BASE read</li>
                    <li><strong>APIC Enable:</strong> Enable bit check</li>
                    <li><strong>IOAPIC:</strong> Detection via ACPI MADT (structure ready)</li>
                </ul>

                <h3>6. Storage Detection</h3>
                <ul>
                    <li><strong>ATA:</strong> Primary (0x1F0) and secondary (0x170) ports</li>
                    <li><strong>SATA:</strong> Via PCI enumeration (class 0x01, subclass 0x06)</li>
                    <li><strong>NVMe:</strong> Via PCI enumeration (class 0x01, subclass 0x08)</li>
                    <li><strong>Device Types:</strong> Type classification</li>
                    <li><strong>Port Tracking:</strong> I/O port or PCI bus/device</li>
                </ul>

                <h3>7. Display Detection</h3>
                <ul>
                    <li><strong>VGA:</strong> Standard x86 VGA (always present)</li>
                    <li><strong>VESA/VBE:</strong> BIOS extensions (INT 0x10, AX=0x4F00)</li>
                    <li><strong>GPU:</strong> Via PCI enumeration (class 0x03)</li>
                    <li><strong>Vendor/Device ID:</strong> GPU identification</li>
                    <li><strong>Framebuffer:</strong> Framebuffer address detection</li>
                </ul>

                <h3>8. Network Detection</h3>
                <ul>
                    <li><strong>Ethernet:</strong> Via PCI (class 0x02, subclass 0x00)</li>
                    <li><strong>WiFi:</strong> Via PCI (class 0x02, subclass 0x80)</li>
                    <li><strong>Vendor/Device ID:</strong> Network adapter identification</li>
                    <li><strong>PCI Location:</strong> Bus/device/function tracking</li>
                </ul>

                <h3>9. Audio Detection</h3>
                <ul>
                    <li><strong>AC97:</strong> Via PCI (class 0x04, subclass 0x01, prog_if 0x00)</li>
                    <li><strong>HDA:</strong> Via PCI (class 0x04, subclass 0x01, prog_if 0x01)</li>
                    <li><strong>USB Audio:</strong> Via USB enumeration (structure ready)</li>
                    <li><strong>Codec ID:</strong> Audio codec identification</li>
                </ul>

                <h3>10. Input Detection</h3>
                <ul>
                    <li><strong>PS/2 Keyboard:</strong> Always present on x86</li>
                    <li><strong>PS/2 Mouse:</strong> Detection via PS/2 controller</li>
                    <li><strong>USB Input:</strong> Via USB enumeration (structure ready)</li>
                    <li><strong>Interface Type:</strong> PS/2, USB, I2C classification</li>
                </ul>

                <h3>11. USB Detection</h3>
                <ul>
                    <li><strong>USB Controllers:</strong> Via PCI enumeration</li>
                    <li><strong>Class Code:</strong> 0x0C (Serial Bus Controller)</li>
                    <li><strong>Subclass:</strong> 0x03 (USB)</li>
                    <li><strong>Controller Count:</strong> Number of USB controllers</li>
                </ul>

                <h3>12. NUMA Detection</h3>
                <ul>
                    <li><strong>SRAT Parsing:</strong> Structure ready for SRAT parsing</li>
                    <li><strong>Node Count:</strong> NUMA node detection</li>
                    <li><strong>ACPI-Based:</strong> Uses ACPI SRAT table</li>
                </ul>
            </section>

            <section class="section">
                <h2>Data Structures</h2>
                
                <h3>Early Hardware Info Structure</h3>
                <pre><code>struc EARLY_HARDWARE_INFO
    .cpu_count: resb 1
    .cpu_vendor: resb 13
    .cpu_brand: resb 48
    .cpu_features: resq 1
    .cpu_extended_features: resq 1
    .cpu_cache_info: resq 1
    .memory_total: resq 1
    .memory_available: resq 1
    .memory_reserved: resq 1
    .acpi_present: resb 1
    .acpi_version: resb 1
    .acpi_rsdp: resq 1
    .pci_present: resb 1
    .pci_device_count: resd 1
    .apic_present: resb 1
    .apic_base: resq 1
    .ioapic_present: resb 1
    .ioapic_base: resq 1
    .numa_nodes: resb 1
    .storage_count: resb 1
    .display_count: resb 1
    .network_count: resb 1
    .audio_count: resb 1
    .usb_count: resb 1
    .input_count: resb 1
endstruc</code></pre>

                <h3>PCI Device Structure</h3>
                <pre><code>struc PCI_DEVICE
    .bus: resb 1
    .device: resb 1
    .function: resb 1
    .vendor_id: resw 1
    .device_id: resw 1
    .class_code: resd 1
    .subclass: resb 1
    .prog_if: resb 1
    .revision: resb 1
    .header_type: resb 1
    .bar0: resd 1
    .bar1: resd 1
    .irq: resb 1
endstruc</code></pre>
            </section>

            <section class="section">
                <h2>API Functions</h2>
                
                <h3>Get Early Hardware Info</h3>
                <pre><code>get_early_hardware_info:
    ; Returns: RAX = pointer to early_hardware_info</code></pre>

                <h3>Get Memory Map</h3>
                <pre><code>get_memory_map:
    ; Returns: RAX = pointer to memory_map_entries
    ;          RCX = entry count</code></pre>

                <h3>Get PCI Devices</h3>
                <pre><code>get_pci_devices:
    ; Returns: RAX = pointer to pci_devices
    ;          RCX = device count</code></pre>

                <h3>Get Storage Devices</h3>
                <pre><code>get_storage_devices:
    ; Returns: RAX = pointer to storage_devices
    ;          CL = device count</code></pre>

                <h3>Get Display Devices</h3>
                <pre><code>get_display_devices:
    ; Returns: RAX = pointer to display_devices
    ;          CL = device count</code></pre>

                <h3>Get Network Devices</h3>
                <pre><code>get_network_devices:
    ; Returns: RAX = pointer to network_devices
    ;          CL = device count</code></pre>

                <h3>Get Audio Devices</h3>
                <pre><code>get_audio_devices:
    ; Returns: RAX = pointer to audio_devices
    ;          CL = device count</code></pre>

                <h3>Get Input Devices</h3>
                <pre><code>get_input_devices:
    ; Returns: RAX = pointer to input_devices
    ;          CL = device count</code></pre>

                <h3>Set UEFI Memory Map</h3>
                <pre><code>set_uefi_memory_map:
    ; Input: RDI = memory map pointer
    ;        RSI = memory map size
    ;        RDX = descriptor size</code></pre>
            </section>

            <section class="section">
                <h2>Integration Points</h2>
                
                <h3>With UEFI Boot</h3>
                <ul>
                    <li>Receives memory map from UEFI bootloader</li>
                    <li>Receives ACPI RSDP from UEFI boot parameters</li>
                    <li>Uses EFI memory map for memory detection</li>
                </ul>

                <h3>With Kernel Initialization</h3>
                <ul>
                    <li>Called before kernel decompression (Phase 0)</li>
                    <li>Provides hardware info for driver loading</li>
                    <li>Memory map used for memory management setup</li>
                </ul>

                <h3>With Driver System</h3>
                <ul>
                    <li>PCI devices enumerated for driver matching</li>
                    <li>Device structures available for driver initialization</li>
                    <li>Hardware capabilities known before driver load</li>
                </ul>
            </section>

            <section class="section">
                <h2>Usage Example</h2>
                
                <pre><code>; In kernel initialization
extern early_hardware_detect
call early_hardware_detect

; Get hardware information
extern get_early_hardware_info
call get_early_hardware_info
; RAX now points to early_hardware_info structure

; Access CPU count
mov al, [rax + EARLY_HARDWARE_INFO.cpu_count]

; Access memory total
mov rbx, [rax + EARLY_HARDWARE_INFO.memory_total]

; Access PCI device count
mov ecx, [rax + EARLY_HARDWARE_INFO.pci_device_count]

; Get PCI devices
extern get_pci_devices
call get_pci_devices
; RAX = pointer to pci_devices
; RCX = device count</code></pre>
            </section>

            <section class="section">
                <h2>Detection Flow</h2>
                
                <pre><code>Early Hardware Detection (before drivers)
    ↓
1. CPU Detection
   - Vendor, brand, features
   - Cache information
   - CPU count
    ↓
2. Memory Detection
   - E820 (BIOS) or EFI (UEFI)
   - Memory map parsing
   - Total/available/reserved calculation
    ↓
3. ACPI Detection
   - RSDP search or from UEFI
   - Version detection
   - Table location
    ↓
4. PCI Enumeration
   - Full bus/device/function scan
   - Device classification
   - Device structure storage
    ↓
5. APIC Detection
   - Local APIC (MSR)
   - IOAPIC (ACPI MADT)
    ↓
6. Device-Specific Detection
   - Storage (ATA, SATA, NVMe)
   - Display (VGA, VESA, GPU)
   - Network (Ethernet, WiFi)
   - Audio (AC97, HDA)
   - Input (PS/2, USB)
   - USB controllers
    ↓
7. NUMA Detection
   - SRAT parsing
   - Node count
    ↓
Hardware Info Structure Populated</code></pre>
            </section>

            <section class="section">
                <h2>Related Documentation</h2>
                <ul>
                    <li><a href="uefi-boot.html">UEFI Boot</a> - Memory map and ACPI RSDP passing</li>
                    <li><a href="kernel.html">Kernel</a> - Kernel initialization phases</li>
                    <li><a href="drivers.html">Device Drivers</a> - Driver matching using hardware info</li>
                    <li><a href="memory.html">Memory Management</a> - Memory map usage</li>
                </ul>
            </section>
        </main>
    </div>

    <footer>
        <p>FreeWorld OS Documentation v0.1.0</p>
    </footer>

    <script src="../navigation.js"></script>
</body>
</html>

