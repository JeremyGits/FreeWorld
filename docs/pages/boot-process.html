<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boot Process - FreeWorld OS Documentation</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <h2>Navigation</h2>
            <ul class="nav-menu">
                <li><a href="../index.html">Home</a></li>
                <li class="nav-section">Boot Components</li>
                <li><a href="bootmgr.html">BOOTMGR</a></li>
                <li><a href="bcd.html">BCD</a></li>
                <li><a href="freeload.html">freeload.exe</a></li>
                <li class="nav-section">Core System</li>
                <li><a href="kernel.html">fwoskrnl.exe</a></li>
                <li><a href="hal.html">hal.dll</a></li>
                <li class="nav-section">Services</li>
                <li><a href="smss.html">smss.exe</a></li>
                <li><a href="csrss.html">csrss.exe</a></li>
                <li><a href="freeworldlogon.html">freeworldlogon.exe</a></li>
                <li class="nav-section">User Interface</li>
                <li><a href="shell.html">Shell</a></li>
                <li><a href="wanderer.html">Wanderer</a></li>
                <li class="nav-section">GUI Subsystems</li>
                <li><a href="dc.html">Device Context</a></li>
                <li><a href="compositor.html">Compositor</a></li>
                <li><a href="resources.html">Resource Manager</a></li>
                <li class="nav-section">System Services</li>
                <li><a href="api.html">System API</a></li>
                <li><a href="filesystem.html">Filesystem API</a></li>
                <li class="nav-section">Node.js System</li>
                <li><a href="window.html">Window API</a></li>
                <li><a href="desktop.html">Desktop</a></li>
                <li><a href="integration.html">System Integration</a></li>
                <li class="nav-section">Reference</li>
                <li><a href="naming-conventions.html">Naming Conventions</a></li>
                <li><a href="boot-process.html">Boot Process</a></li>
                <li><a href="architecture.html">Architecture</a></li>
                <li><a href="syscalls.html">System Calls</a></li>
                <li><a href="variables.html">Variables & Constants</a></li>
            </ul>
        </nav>

        <main class="content">
            <div class="page-header">
                <h1>Boot Process</h1>
                <div class="meta">
                    <strong>Purpose:</strong> Complete boot sequence documentation
                </div>
            </div>

            <section class="section">
                <h2>Overview</h2>
                <p>The FreeWorld OS boot process follows a multi-stage sequence from BIOS/UEFI initialization to user login.</p>
            </section>

            <section class="section">
                <h2>Boot Sequence</h2>
                <ol>
                    <li><strong>BIOS/UEFI Initialization</strong>
                        <ul>
                            <li>BIOS/UEFI performs hardware initialization</li>
                            <li>BIOS/UEFI loads boot sector from disk</li>
                        </ul>
                    </li>
                    <li><strong>Stage 1 Bootloader (bootloader_stage1.asm)</strong>
                        <ul>
                            <li>BIOS loads boot sector (512 bytes) to 0x7C00</li>
                            <li>Stage 1 initializes segments, stack, and serial port (COM1)</li>
                            <li>Stage 1 initializes VGA text mode (80x25)</li>
                            <li>Stage 1 displays "Loading FreeWorld OS..." message</li>
                            <li>Stage 1 attempts LBA extended read (INT 0x13, AH=0x42) with fallback to CHS</li>
                            <li><strong>Critical:</strong> Uses CHS sector 3 (physical sector 2) to load stage 2</li>
                            <li><strong>Note:</strong> CHS sectors are 1-based, physical sectors are 0-based</li>
                            <li>Stage 1 verifies stage 2 signature ('OB' = 0x424F)</li>
                            <li>Stage 1 passes boot device number to stage 2</li>
                            <li>Stage 1 jumps to stage 2 at 0x0000:0x7E00</li>
                        </ul>
                    </li>
                    <li><strong>Stage 2 Bootloader (bootloader_ui.asm)</strong>
                        <ul>
                            <li>Stage 2 starts at 0x7E00 (right after stage 1)</li>
                            <li>Stage 2 initializes segments and stack</li>
                            <li>Stage 2 initializes graphics mode (VESA or VGA)</li>
                            <li>Stage 2 loads graphics from disk:
                                <ul>
                                    <li>Logo: CHS sector 7 (physical sector 6)</li>
                                    <li>Background: CHS sector 15 (physical sector 14)</li>
                                    <li>Selection highlight: CHS sector 25 (physical sector 24)</li>
                                    <li>Progress bar: CHS sector 27 (physical sector 26)</li>
                                    <li>Error icon: CHS sector 29 (physical sector 28)</li>
                                    <li>Success icon: CHS sector 31 (physical sector 30)</li>
                                </ul>
                            </li>
                            <li>Stage 2 displays boot menu with graphics</li>
                            <li>Stage 2 waits for user selection</li>
                            <li>Stage 2 loads kernel from CHS sector 33 (physical sector 33)</li>
                            <li>Stage 2 verifies kernel signature ('FREEWORL')</li>
                            <li>Stage 2 jumps to kernel entry point (0x1000:0x0000)</li>
                        </ul>
                    </li>
                    <li><strong>BCD (Boot Configuration Data) - PLANNED</strong>
                        <ul>
                            <li><em>Status: Not yet implemented</em></li>
                            <li>Planned: freeload.exe will read BCD file</li>
                            <li>Planned: BCD will provide boot entry configuration</li>
                            <li>Planned: Will contain kernel and loader paths</li>
                        </ul>
                    </li>
                    <li><strong>freeload.exe (OS Loader) - PLANNED</strong>
                        <ul>
                            <li><em>Status: Not yet implemented</em></li>
                            <li>Planned: Will load BCD configuration</li>
                            <li>Planned: Will load kernel (fwoskrnl.exe) into memory</li>
                            <li>Planned: Will load essential device drivers</li>
                            <li>Planned: Will transfer control to kernel</li>
                            <li><strong>Current:</strong> BOOTMGR directly loads kernel from disk</li>
                        </ul>
                    </li>
                    <li><strong>fwoskrnl.exe (Kernel Entry - kernel_entry.asm)</strong>
                        <ul>
                            <li>Kernel loaded at 0x1000:0x0000 (linear 0x10000)</li>
                            <li>Boot sequence: 16-bit real mode → 32-bit protected mode → 64-bit long mode</li>
                            <li>Verify kernel magic number ("FREEWORL")</li>
                            <li>Initialize hardware (serial port COM1)</li>
                            <li>Display kernel messages</li>
                            <li>Detect memory using INT 15h E820</li>
                            <li><strong>Protected Mode Transition:</strong>
                                <ul>
                                    <li>Disable interrupts (cli)</li>
                                    <li>Load GDT (lgdt)</li>
                                    <li>Enable A20 line (port 0x92)</li>
                                    <li>Set CR0.PE bit (protected mode enable)</li>
                                    <li>32-bit far jump to protected_mode_start (0x10191)</li>
                                </ul>
                            </li>
                            <li>Set up segment registers (DS, ES, FS, GS, SS = 0x10)</li>
                            <li>Set up stack (ESP = 0x90000)</li>
                            <li>Remap PIC (Programmable Interrupt Controller) - IRQ0-7 → INT 0x20-0x27</li>
                            <li>Set up full IDT (256 entries):
                                <ul>
                                    <li>0-31: Exception handlers (all 32 CPU exceptions)</li>
                                    <li>32 (0x20): Timer interrupt (IRQ0) handler</li>
                                    <li>33 (0x21): Keyboard interrupt (IRQ1) handler</li>
                                    <li>34-47: Other hardware interrupts (IRQ2-IRQ15)</li>
                                    <li>128 (0x80): System call handler</li>
                                    <li>129-255: Generic interrupt handlers</li>
                                </ul>
                            </li>
                            <li>Configure PIT (Programmable Interval Timer) - ~100 Hz for testing</li>
                            <li>Unmask IRQ0 (timer) and IRQ1 (keyboard) in PIC</li>
                            <li>Initialize all 32-bit subsystems (memory, drivers, process, filesystem, graphics)</li>
                            <li><strong>64-bit Long Mode Transition:</strong>
                                <ul>
                                    <li>Check CPUID for long mode support (EDX bit 29)</li>
                                    <li>Disable paging temporarily (clear CR0.PG)</li>
                                    <li>Set up 4-level page tables (PML4, PDPT, PD, PT)</li>
                                    <li>Load 64-bit GDT (with L=1 bit for long mode)</li>
                                    <li>Enable PAE (set CR4.PAE bit)</li>
                                    <li>Enable long mode (set EFER.LME via MSR 0xC0000080)</li>
                                    <li>Enable paging (set CR0.PG) - this activates long mode</li>
                                    <li>64-bit far jump to long_mode_entry (segment 0x08)</li>
                                </ul>
                            </li>
                            <li>Set up 64-bit segment registers (DS, ES, FS, GS, SS = 0x10)</li>
                            <li>Set up 64-bit stack (RSP = 0x200000)</li>
                            <li>Initialize 64-bit subsystems</li>
                            <li>Enter 64-bit kernel main loop</li>
                        </ul>
                    </li>
                    <li><strong>hal.dll (Hardware Abstraction Layer)</strong>
                        <ul>
                            <li>HAL initialization (hal_init)</li>
                            <li>Detect CPU</li>
                            <li>Detect memory</li>
                            <li>Detect devices</li>
                            <li>Initialize device drivers</li>
                        </ul>
                    </li>
                    <li><strong>smss.exe (Session Manager)</strong>
                        <ul>
                            <li>Initialize user session</li>
                            <li>Load critical system processes</li>
                            <li>Start CSRSS</li>
                            <li>Start login manager</li>
                        </ul>
                    </li>
                    <li><strong>csrss.exe (Client Server Runtime)</strong>
                        <ul>
                            <li>Initialize console subsystem</li>
                            <li>Initialize window manager</li>
                            <li>Start message loop</li>
                        </ul>
                    </li>
                    <li><strong>freeworldlogon.exe (Login Manager)</strong>
                        <ul>
                            <li>Display login prompt</li>
                            <li>Authenticate user</li>
                            <li>Start user shell</li>
                        </ul>
                    </li>
                    <li><strong>shell.exe (User Shell)</strong>
                        <ul>
                            <li>Display "FREE WORLD>" prompt</li>
                            <li>Accept user commands</li>
                            <li>Execute commands</li>
                        </ul>
                    </li>
                </ol>
            </section>

            <section class="section">
                <h2>Memory Layout During Boot</h2>
                <div class="code-block">
                    <pre>0x0000 - 0x03FF  : Interrupt Vector Table (IVT)
0x0400 - 0x04FF  : BIOS Data Area
0x0500 - 0x7BFF  : Available
0x7C00 - 0x7DFF  : Stage 1 Bootloader (512 bytes)
0x7E00 - 0x9FFF  : Stage 2 Bootloader (~2KB)
0x8000 - 0x8FFF  : Graphics Index Table
0x9000 - 0x9FFF  : Logo Graphics Buffer
0xA000 - 0xAFFF  : Background Graphics Buffer
0xB000 - 0xB7FF  : Selection Highlight Buffer
0xB800 - 0xBFFF  : Progress Bar Buffer
0xC000 - 0xC1FF  : Error Icon Buffer
0xC200 - 0xC3FF  : Success Icon Buffer
0xA000 - 0xBFFF  : Video Memory (VGA)
0xC000 - 0xFFFF  : BIOS ROM
0x1000:0x0000    : Kernel Entry Point (linear 0x10000)
0x1000:0x2000    : Memory Map Buffer (E820 results)
0x8000          : IDT (Interrupt Descriptor Table)
0x90000          : Stack (protected mode)</pre>
                </div>
                <h3>64-bit Long Mode Memory Layout</h3>
                <p>After transitioning to 64-bit long mode, the memory layout uses 48-bit virtual addressing:</p>
                <div class="code-block">
                    <pre>0x0000000000000000 : Null page (unmapped)
0x0000000000100000 : Kernel base (1MB)
0x0000000000200000 : 64-bit stack (2MB)
0x0000000000201000 : PML4 table
0x0000000000202000 : PDPT table
0x0000000000203000 : Page Directory
0x0000000000204000 : Page Table
0x00007FFFFFFFFFFF : Maximum 48-bit user space address
0xFFFF800000000000 : Kernel space start
0xFFFFFFFFFFFFFFFF : Maximum 64-bit address</pre>
                </div>

                <h3>Protected Mode Memory Layout</h3>
                <p>After transitioning to protected mode (before long mode), the memory layout uses flat addressing:</p>
                <ul>
                    <li><strong>0x00000000 - 0x000FFFFF:</strong> Real mode compatibility (first 1MB)</li>
                    <li><strong>0x00010000:</strong> Kernel entry point</li>
                    <li><strong>0x00008000:</strong> IDT (256 entries × 8 bytes = 2048 bytes)</li>
                    <li><strong>0x00090000:</strong> Stack pointer (grows downward)</li>
                    <li><strong>0xFFFFFFFF:</strong> Maximum 32-bit address (4GB limit)</li>
                </ul>
            </section>

            <section class="section">
                <h2>JMP Instructions</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th>Instruction</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>BOOTMGR</td>
                            <td><code>jmp 0x1000:0x0000</code></td>
                            <td>Far jump to kernel entry point (16-bit real mode)</td>
                        </tr>
                        <tr>
                            <td>BOOTMGR (print_string)</td>
                            <td><code>jz done</code></td>
                            <td>Conditional jump if end of string</td>
                        </tr>
                        <tr>
                            <td>BOOTMGR (print_string)</td>
                            <td><code>jmp print_string</code></td>
                            <td>Unconditional jump to continue loop</td>
                        </tr>
                        <tr>
                            <td>Kernel (enter_protected_mode)</td>
                            <td><code>db 0x66, 0xEA; dd 0x00010191; dw 0x08</code></td>
                            <td>32-bit far jump to protected mode entry point (0x10191, segment 0x08)</td>
                        </tr>
                        <tr>
                            <td>Kernel (protected_mode_start)</td>
                            <td><code>call setup_minimal_idt</code></td>
                            <td>Call to set up IDT (after segment registers)</td>
                        </tr>
                    </tbody>
                </table>
                <div class="alert alert-info">
                    <strong>Note:</strong> The 32-bit far jump uses opcodes <code>0x66 0xEA</code> followed by a 32-bit offset and 16-bit segment selector. This is required because the target address (0x10191) exceeds 64KB.
                </div>
            </section>

            <section class="section">
                <h2>Disk Layout</h2>
                <p>The boot disk is organized as follows:</p>
                <div class="code-block">
                    <pre>Physical Sector 0  : Stage 1 Bootloader (MBR, 512 bytes)
Physical Sector 1  : Unused
Physical Sector 2  : Stage 2 Bootloader start (CHS sector 3)
Physical Sectors 2-5: Stage 2 Bootloader (4 sectors, ~2KB)
Physical Sector 6  : Graphics start (Logo, CHS sector 7)
Physical Sectors 6-32: Graphics resources
Physical Sector 33 : Kernel start (CHS sector 33)</pre>
                </div>
                
                <div class="alert alert-warning">
                    <strong>Important:</strong> CHS (Cylinder-Head-Sector) addressing uses 1-based sector numbering, while physical sectors are 0-based. This means:
                    <ul>
                        <li>Physical sector 0 = CHS sector 1 (MBR)</li>
                        <li>Physical sector 2 = CHS sector 3 (Stage 2 start)</li>
                        <li>Physical sector 6 = CHS sector 7 (Graphics start)</li>
                        <li>Physical sector 33 = CHS sector 33 (Kernel start)</li>
                    </ul>
                </div>
            </section>

            <section class="section">
                <h2>Boot Sector Format</h2>
                <ul>
                    <li><strong>Size:</strong> 512 bytes (exactly)</li>
                    <li><strong>Boot Signature:</strong> 0xAA55 at bytes 510-511</li>
                    <li><strong>Load Address:</strong> 0x7C00</li>
                    <li><strong>Mode:</strong> 16-bit real mode</li>
                    <li><strong>Disk Access:</strong> LBA extended read (INT 0x13, AH=0x42) with CHS fallback</li>
                </ul>
            </section>

            <section class="section">
                <h2>Current Implementation Status</h2>
                <div class="alert alert-info">
                    <strong>Note:</strong> FreeWorld OS currently uses a simplified two-stage boot process. Advanced boot stages (BCD, freeload.exe) are planned but not yet implemented.
                </div>
                
                <h3>Implemented Stages</h3>
                <ul>
                    <li><strong>✅ Stage 1 Bootloader (bootloader_stage1.asm):</strong> Fully functional MBR bootloader</li>
                    <li><strong>✅ Stage 2 Bootloader (bootloader_ui.asm):</strong> Graphical bootloader with menu</li>
                    <li><strong>✅ Graphics Loader (graphics_loader.asm):</strong> Loads boot graphics from disk</li>
                    <li><strong>✅ Kernel Entry (kernel_entry.asm):</strong> Fully functional kernel initialization</li>
                </ul>

                <h3>Planned Stages (Not Yet Implemented)</h3>
                <ul>
                    <li><strong>⏳ BCD (Boot Configuration Data):</strong> Boot configuration database</li>
                    <li><strong>⏳ freeload.exe:</strong> Advanced OS loader with BCD support</li>
                </ul>

                <h3>Boot Process Details</h3>
                <p><strong>Stage 1 Bootloader (bootloader_stage1.asm):</strong></p>
                <ul>
                    <li>Loaded by BIOS at 0x7C00 (512 bytes, MBR)</li>
                    <li>Initializes serial port (COM1 at 0x3F8) for debugging</li>
                    <li>Initializes VGA text mode (80x25)</li>
                    <li>Checks for LBA extended read support (INT 0x13, AH=0x41)</li>
                    <li>Uses LBA extended read (INT 0x13, AH=0x42) if supported, falls back to CHS</li>
                    <li>Loads stage 2 from CHS sector 3 (physical sector 2) to 0x0000:0x7E00</li>
                    <li>Verifies stage 2 signature ('OB' = 0x424F)</li>
                    <li>Passes boot device number to stage 2</li>
                    <li>Jumps to stage 2 at 0x0000:0x7E00</li>
                </ul>
                
                <p><strong>Stage 2 Bootloader (bootloader_ui.asm):</strong></p>
                <ul>
                    <li>Starts at 0x7E00 (loaded by stage 1)</li>
                    <li>Initializes graphics mode (VESA or VGA)</li>
                    <li>Loads graphics resources from disk using CHS addressing</li>
                    <li>Displays graphical boot menu</li>
                    <li>Waits for user selection (keyboard input)</li>
                    <li>Loads kernel from CHS sector 33 (physical sector 33) to 0x1000:0x0000</li>
                    <li>Verifies kernel magic number "FREEWORL"</li>
                    <li>Jumps to kernel entry point (0x1000:0x0000)</li>
                </ul>
                
                <div class="alert alert-info">
                    <strong>Key Discovery:</strong> The bootloader was fixed to correctly handle CHS sector addressing. Physical sectors are 0-based, but CHS sectors are 1-based. This means physical sector 2 corresponds to CHS sector 3, not CHS sector 2.
                </div>

                <p><strong>Kernel Entry (kernel_entry.asm):</strong></p>
                <ul>
                    <li>Starts in 16-bit real mode at 0x1000:0x0000</li>
                    <li>Initializes hardware (serial port COM1, FIFO disabled for reliability)</li>
                    <li>Detects memory using INT 15h E820</li>
                    <li>Transitions to 32-bit protected mode</li>
                    <li>Sets up GDT, IDT, PIC remapping, PIT configuration</li>
                    <li>Enters main kernel loop</li>
                </ul>
            </section>
        </main>
    </div>

    <footer>
        <p>FreeWorld OS Documentation v0.1.0</p>
    </footer>

    <script src="../navigation.js"></script>
</body>
</html>

